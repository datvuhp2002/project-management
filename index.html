<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      #messages {
        border: 1px solid #ccc;
        height: 200px;
        overflow-y: scroll;
        padding: 5px;
      }
      #form {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="messages"></div>

    <!-- Token Login Form -->
    <form id="tokenForm">
      <input id="tokenInput" placeholder="Access Token" autocomplete="off" />
      <button id="connectButton">Connect</button>
    </form>

    <!-- Form to Update Department -->
    <form id="updateDepartmentForm" style="margin-top: 10px; display: none">
      <input id="nameInput" placeholder="Department Name" autocomplete="off" />
      <button id="updateButton">Update Department</button>
    </form>

    <script>
      let socket;
      let accessToken;

      document
        .getElementById("tokenForm")
        .addEventListener("submit", (event) => {
          event.preventDefault();
          accessToken = document.getElementById("tokenInput").value;
          if (accessToken) {
            socket = io("http://localhost:3050", {
              auth: {
                token: accessToken,
              },
            });

            socket.on("connect", () => {
              console.log("Connected to server");
              document.getElementById("tokenForm").style.display = "none";
              document.getElementById("updateDepartmentForm").style.display =
                "block";
            });

            socket.on("connect_error", (error) => {
              console.error("Connection failed:", error.message);
              alert("Connection failed: " + error.message);
            });

            socket.on("new-noti", (msg) => {
              console.log("Received notification:", msg);
              const item = document.createElement("div");
              item.textContent = `Notification: ${JSON.stringify(msg)}`;
              document.getElementById("messages").appendChild(item);
            });
          }
        });

      document
        .getElementById("updateDepartmentForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const name = document.getElementById("nameInput").value;
          if (name) {
            try {
              const response = await fetch(
                "http://localhost:3050/departments/admin/update/666d56ef15136fb8b7501356",
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                    authorization: `${accessToken}`,
                  },
                  body: JSON.stringify({ name }),
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const result = await response.json();
              console.log("Department updated:", result);
              // Optionally, you can display a message to the user
              const item = document.createElement("div");
              item.textContent = `Department updated successfully!`;
              document.getElementById("messages").appendChild(item);
            } catch (error) {
              console.error("Error updating department:", error.message);
              const item = document.createElement("div");
              item.textContent = `Error updating department: ${error.message}`;
              document.getElementById("messages").appendChild(item);
            }
          }
        });

      socket.on("chat message", (msg) => {
        const item = document.createElement("div");
        item.textContent = `User: ${msg}`;
        document.getElementById("messages").appendChild(item);
      });
    </script>
  </body>
</html>
